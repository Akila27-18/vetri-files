{% extends "base.html" %}
{% block title %}Redact PDF – VetriFiles{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">

        <h4 class="mb-3 text-dark">Redact PDF</h4>

        <!-- PDF Preview -->
        <div id="pdf-preview"
             class="border p-2 mb-3"
             style="height:300px; overflow-y:auto; background:#f8f9fa;">
            <p class="text-muted text-center mt-5">No PDF loaded</p>
        </div>

        <form id="redact-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div id="drop-area" class="border p-4 text-center mb-3 text-dark">
                Drag & drop PDF here or click to select
                <input type="file" name="pdf" id="fileElem" accept="application/pdf" hidden required>
            </div>

            <input type="text" name="text"
                   class="form-control mb-3"
                   placeholder="Text to redact (e.g. Aadhaar, Email)"
                   required>

            <button class="btn btn-danger w-100">
                Redact PDF
            </button>
        </form>

        <p class="text-muted mt-3">
            Permanently remove sensitive information.
        </p>

    </div>
</div>

<script>
let uploadedFile = null;
let pdfDoc = null;

const preview = document.getElementById("pdf-preview");
const fileElem = document.getElementById("fileElem");
const dropArea = document.getElementById("drop-area");
const form = document.getElementById("redact-form");

/* -----------------------------
   Drag & Drop
-------------------------------- */
dropArea.onclick = () => fileElem.click();
dropArea.ondragover = e => { e.preventDefault(); dropArea.classList.add("bg-light"); }
dropArea.ondragleave = () => dropArea.classList.remove("bg-light");
dropArea.ondrop = e => { e.preventDefault(); dropArea.classList.remove("bg-light"); handleFile(e.dataTransfer.files[0]); }

fileElem.onchange = e => handleFile(e.target.files[0]);

/* -----------------------------
   Handle File
-------------------------------- */
function handleFile(file){
    if(!file || file.type !== "application/pdf") return;
    uploadedFile = file;
    preview.innerHTML = "";
    loadPDF(file);
}

/* -----------------------------
   PDF Preview
-------------------------------- */
function loadPDF(file){
    file.arrayBuffer().then(data => {
        pdfjsLib.getDocument({ data }).promise.then(doc => {
            pdfDoc = doc;
            renderAllPages();
        });
    });
}

async function renderAllPages(){
    preview.innerHTML = "";
    for(let i=1; i<=pdfDoc.numPages; i++){
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 1.0 });
        const canvas = document.createElement("canvas");
        canvas.className = "mb-2 shadow-sm bg-white";
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
        preview.appendChild(canvas);
    }
}

/* -----------------------------
   Submit & Download
-------------------------------- */
form.onsubmit = async e => {
    e.preventDefault();
    if(!uploadedFile) return;

    const fd = new FormData(form);
    fd.append("pdf", uploadedFile);

    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const res = await fetch("", { method:"POST", headers:{"X-CSRFToken": csrf}, body: fd });

    if(!res.ok){ alert("Redaction failed"); return; }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;

    // ✅ Keep base filename and add "_redacted.pdf"
    const name = uploadedFile.name.replace(/\.pdf$/i, "_redacted.pdf");
    a.download = name;

    a.click();
}
</script>
{% endblock %}
