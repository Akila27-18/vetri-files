{% extends "base.html" %}
{% block title %}Merge PDF – VetriFiles{% endblock %}

{% block content %}
<div class="row">
    <!-- Preview -->
    <div class="col-md-6">
        <h5 class="text-dark">PDF Preview (Merged Order)</h5>
        <div id="pdf-preview" class="border p-2"
             style="height:400px; overflow-y:auto; background:#f8f9fa;"></div>
    </div>

    <!-- Controls -->
    <div class="col-md-6">
        <h5 class="text-dark">Merge PDFs</h5>

        <form id="merge-form">
            {% csrf_token %}

            <div id="drop-area" class="border p-4 text-center mb-3 text-dark">
                Drag & drop PDFs here or click to select
                <input type="file" id="fileElem" accept="application/pdf" multiple hidden>
            </div>

            <ul id="file-list" class="list-group mb-3"></ul>

            <button type="submit" class="btn btn-primary w-100">
                Merge PDFs
            </button>
        </form>
    </div>
</div>

<script>
let files = []

const preview = document.getElementById("pdf-preview")
const fileList = document.getElementById("file-list")
const fileElem = document.getElementById("fileElem")
const dropArea = document.getElementById("drop-area")

/* -----------------------------
   Drag & Drop
-------------------------------- */
dropArea.onclick = () => fileElem.click()

dropArea.ondragover = e => {
    e.preventDefault()
    dropArea.classList.add("bg-light")
}

dropArea.ondragleave = () => dropArea.classList.remove("bg-light")

dropArea.ondrop = e => {
    e.preventDefault()
    dropArea.classList.remove("bg-light")
    addFiles([...e.dataTransfer.files])
}

fileElem.onchange = e => addFiles([...e.target.files])

/* -----------------------------
   Add & List Files
-------------------------------- */
function addFiles(newFiles){
    newFiles.forEach(file => {
        if (file.type === "application/pdf") {
            files.push(file)
            renderFileList()
            previewPDF(file)
        }
    })
}

function renderFileList(){
    fileList.innerHTML = ""
    files.forEach((file, index) => {
        const li = document.createElement("li")
        li.className = "list-group-item"
        li.textContent = `${index + 1}. ${file.name}`
        fileList.appendChild(li)
    })
}

/* -----------------------------
   PDF Preview
-------------------------------- */
async function previewPDF(file){
    const data = await file.arrayBuffer()
    const doc = await pdfjsLib.getDocument({ data }).promise

    for (let i = 1; i <= doc.numPages; i++) {
        const page = await doc.getPage(i)
        const viewport = page.getViewport({ scale: 1 })
        const canvas = document.createElement("canvas")
        canvas.className = "mb-3 shadow-sm bg-white"
        canvas.width = viewport.width
        canvas.height = viewport.height

        await page.render({
            canvasContext: canvas.getContext("2d"),
            viewport
        }).promise

        preview.appendChild(canvas)
    }
}

/* -----------------------------
   Submit & Download
-------------------------------- */
document.getElementById("merge-form").onsubmit = async e => {
    e.preventDefault()
    if (!files.length) return

    const fd = new FormData()
    files.forEach(file => fd.append("pdfs", file))

    const csrf = document.querySelector(
        '[name=csrfmiddlewaretoken]'
    ).value

    const res = await fetch("", {
        method: "POST",
        headers: { "X-CSRFToken": csrf },
        body: fd
    })

    if (!res.ok) {
        alert("Merge failed")
        return
    }

    const blob = await res.blob()
    const url = URL.createObjectURL(blob)

    const a = document.createElement("a")
    a.href = url

    // ✅ SAME filename as first input file
    a.download = files[0].name

    a.click()
}
</script>
{% endblock %}
