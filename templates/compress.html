{% extends "base.html" %}
{% block title %}Compress PDF – VetriFiles{% endblock %}

{% block content %}
<div class="row">
    <!-- Preview -->
    <div class="col-md-6">
        <h5>PDF Preview</h5>
        <div id="pdf-preview"
             class="border p-2"
             style="height:400px; overflow-y:auto; background:#f8f9fa;"></div>
    </div>

    <!-- Controls -->
    <div class="col-md-6">
        <h5>Compress PDF</h5>

        <form id="compress-form">
            {% csrf_token %}

            <div id="drop-area" class="border p-4 text-center mb-3">
                Drag & drop PDF here or click to select
                <input type="file" id="fileElem" accept="application/pdf" hidden>
            </div>

            <select class="form-select mb-3" id="level">
                <option value="recommended">Recommended</option>
                <option value="extreme">Extreme</option>
                <option value="less">Less compression</option>
            </select>

            <button type="submit" class="btn btn-primary w-100">
                Compress PDF
            </button>
        </form>
    </div>
</div>

<script>
let uploadedFile = null
let pdfDoc = null

const preview = document.getElementById("pdf-preview")
const fileElem = document.getElementById("fileElem")
const dropArea = document.getElementById("drop-area")

/* -----------------------------
   Drag & Drop
-------------------------------- */
dropArea.onclick = () => fileElem.click()

dropArea.ondragover = e => {
    e.preventDefault()
    dropArea.classList.add("bg-light")
}

dropArea.ondragleave = () => dropArea.classList.remove("bg-light")

dropArea.ondrop = e => {
    e.preventDefault()
    dropArea.classList.remove("bg-light")
    handleFile(e.dataTransfer.files[0])
}

fileElem.onchange = e => handleFile(e.target.files[0])

/* -----------------------------
   Handle File
-------------------------------- */
function handleFile(file){
    if (!file || file.type !== "application/pdf") return
    uploadedFile = file
    preview.innerHTML = ""
    loadPDF(file)
}

/* -----------------------------
   PDF Preview
-------------------------------- */
function loadPDF(file){
    file.arrayBuffer().then(data => {
        pdfjsLib.getDocument({ data }).promise.then(doc => {
            pdfDoc = doc
            renderAllPages()
        })
    })
}

async function renderAllPages(){
    preview.innerHTML = ""
    for (let i = 1; i <= pdfDoc.numPages; i++) {
        const page = await pdfDoc.getPage(i)
        const viewport = page.getViewport({ scale: 1.1 })
        const canvas = document.createElement("canvas")
        canvas.className = "mb-3 shadow-sm bg-white"
        canvas.width = viewport.width
        canvas.height = viewport.height

        await page.render({
            canvasContext: canvas.getContext("2d"),
            viewport
        }).promise

        preview.appendChild(canvas)
    }
}

/* -----------------------------
   Submit & Download
-------------------------------- */
document.getElementById("compress-form").onsubmit = async e => {
    e.preventDefault()
    if (!uploadedFile) return

    const fd = new FormData()
    fd.append("pdf", uploadedFile)
    fd.append("level", document.getElementById("level").value)

    const csrf = document.querySelector(
        '[name=csrfmiddlewaretoken]'
    ).value

    const res = await fetch("", {
        method: "POST",
        headers: { "X-CSRFToken": csrf },
        body: fd
    })

    if (!res.ok) {
        alert("Compression failed")
        return
    }

    const blob = await res.blob()
    const url = URL.createObjectURL(blob)

    const a = document.createElement("a")
    a.href = url

    // ✅ SAME filename as input file
    a.download = uploadedFile.name

    a.click()
}
</script>
{% endblock %}
