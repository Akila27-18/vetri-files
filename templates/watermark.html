{% extends "base.html" %}
{% block title %}Watermark PDF â€“ VetriFiles{% endblock %}

{% block content %}
<div class="row">
    <!-- PREVIEW -->
    <div class="col-md-6">
        <h5>PDF Preview</h5>
        <div id="pdf-preview" class="border p-2"
             style="height:400px; overflow-y:auto; background:#f8f9fa;"></div>
    </div>

    <!-- CONTROLS -->
    <div class="col-md-6">
        <h5>Add Watermark</h5>

        <form id="watermark-form">
            {% csrf_token %}

            <div id="drop-area" class="border p-4 text-center mb-3">
                Drag & drop PDF here or click to select
                <input type="file" id="fileElem" accept="application/pdf" hidden>
            </div>

            <input type="text" id="text" class="form-control mb-3"
                   placeholder="Watermark text" value="VetriFiles">

            <label>Opacity</label>
            <input type="range" id="opacity" class="form-range mb-3"
                   min="0.1" max="0.8" step="0.1" value="0.2">

            <label>Position</label>
            <select id="position" class="form-select mb-3">
                <option value="center">Center</option>
                <option value="top">Top</option>
                <option value="bottom">Bottom</option>
            </select>

            <button class="btn btn-primary w-100">
                Apply Watermark
            </button>
        </form>
    </div>
</div>

<script>
let uploadedFile=null, pdfDoc=null
const preview=document.getElementById("pdf-preview")
const fileElem=document.getElementById("fileElem")
const dropArea=document.getElementById("drop-area")

dropArea.onclick=()=>fileElem.click()
dropArea.ondragover=e=>{e.preventDefault();dropArea.classList.add("bg-light")}
dropArea.ondragleave=()=>dropArea.classList.remove("bg-light")
dropArea.ondrop=e=>{
    e.preventDefault()
    dropArea.classList.remove("bg-light")
    handleFile(e.dataTransfer.files[0])
}
fileElem.onchange=e=>handleFile(e.target.files[0])

function handleFile(file){
    if(!file||file.type!=="application/pdf")return
    uploadedFile=file
    preview.innerHTML=""
    file.arrayBuffer().then(data=>{
        pdfjsLib.getDocument({data}).promise.then(doc=>{
            pdfDoc=doc
            render()
        })
    })
}

async function render(){
    for(let i=1;i<=pdfDoc.numPages;i++){
        const page=await pdfDoc.getPage(i)
        const vp=page.getViewport({scale:1.1})
        const canvas=document.createElement("canvas")
        canvas.width=vp.width
        canvas.height=vp.height
        canvas.className="mb-3 shadow-sm bg-white"
        await page.render({
            canvasContext:canvas.getContext("2d"),
            viewport:vp
        }).promise
        preview.appendChild(canvas)
    }
}

document.getElementById("watermark-form").onsubmit=async e=>{
    e.preventDefault()
    if(!uploadedFile)return

    const fd=new FormData()
    fd.append("pdf",uploadedFile)
    fd.append("text",document.getElementById("text").value)
    fd.append("opacity",document.getElementById("opacity").value)
    fd.append("position",document.getElementById("position").value)

    const csrf=document.querySelector('[name=csrfmiddlewaretoken]').value

    const res=await fetch("",{
        method:"POST",
        headers:{ "X-CSRFToken": csrf },
        body:fd
    })

    if(!res.ok){alert("Failed");return}

    const blob=await res.blob()
    const a=document.createElement("a")
    a.href=URL.createObjectURL(blob)
    a.download=uploadedFile.name.replace(".pdf","_watermarked.pdf")
    a.click()
}
</script>
{% endblock %}
