{% extends "base.html" %}
{% load static %}
{% block title %}Crop PDF â€“ VetriFiles{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-10 mx-auto">

      <h3 class="fw-bold mb-3 text-center text-dark">Crop PDF</h3>
      <p class="text-muted text-center mb-4">
        Drag & drop a PDF, crop visually, or enter coordinates manually
      </p>

      <form method="post" enctype="multipart/form-data" id="cropForm">
        {% csrf_token %}

        <!-- Drag & Drop Upload -->
        <div id="drop-area" class="mb-4 text-center">
          <p class="fw-semibold mb-1">Drag & drop PDF here</p>
          <small class="text-muted d-block mb-2">or click to select</small>
          <input type="file" id="fileInput" name="pdf" accept="application/pdf" hidden required>
          <button type="button" class="btn btn-outline-primary btn-sm"
                  onclick="fileInput.click()">Select PDF</button>
        </div>

        <!-- Preview -->
        <div class="position-relative mb-3 text-center">
          <canvas id="pdfCanvas" class="border rounded"></canvas>
          <canvas id="cropCanvas"
                  class="position-absolute top-0 start-0"
                  style="pointer-events:none;"></canvas>
        </div>

        <!-- Hidden crop values -->
        <input type="hidden" name="x1" id="x1">
        <input type="hidden" name="y1" id="y1">
        <input type="hidden" name="x2" id="x2">
        <input type="hidden" name="y2" id="y2">

        <!-- Manual Crop Inputs -->
        <div class="row g-2 mb-3">
          <div class="col">
            <input class="form-control" placeholder="Left (x1)"
                   oninput="syncManual(this,'x1')">
          </div>
          <div class="col">
            <input class="form-control" placeholder="Bottom (y1)"
                   oninput="syncManual(this,'y1')">
          </div>
          <div class="col">
            <input class="form-control" placeholder="Right (x2)"
                   oninput="syncManual(this,'x2')">
          </div>
          <div class="col">
            <input class="form-control" placeholder="Top (y2)"
                   oninput="syncManual(this,'y2')">
          </div>
        </div>

        <button class="btn btn-success w-100">
          Crop & Download
        </button>
      </form>

      <p class="text-muted text-center mt-3">
        PDF coordinate origin starts at bottom-left
      </p>

    </div>
  </div>
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
const dropArea = document.getElementById("drop-area");
const fileInput = document.getElementById("fileInput");
const pdfCanvas = document.getElementById("pdfCanvas");
const cropCanvas = document.getElementById("cropCanvas");
const ctx = pdfCanvas.getContext("2d");
const cropCtx = cropCanvas.getContext("2d");

let pdfPage, scale = 1.3;
let startX, startY, endX, endY, drawing = false;

/* ---------- Drag & Drop ---------- */
["dragenter","dragover"].forEach(e =>
  dropArea.addEventListener(e, ev => {
    ev.preventDefault();
    dropArea.classList.add("bg-light","border-primary");
  })
);

["dragleave","drop"].forEach(e =>
  dropArea.addEventListener(e, ev => {
    ev.preventDefault();
    dropArea.classList.remove("bg-light","border-primary");
  })
);

dropArea.addEventListener("drop", e => {
  const file = e.dataTransfer.files[0];
  if (file) {
    fileInput.files = e.dataTransfer.files;
    loadPDF(file);
  }
});

fileInput.addEventListener("change", e => {
  if (e.target.files.length) loadPDF(e.target.files[0]);
});

/* ---------- Load PDF ---------- */
async function loadPDF(file){
  if (!file || !file.type.includes("pdf")) {
    alert("Please upload a PDF file");
    return;
  }

  const url = URL.createObjectURL(file);
  const pdf = await pdfjsLib.getDocument(url).promise;
  pdfPage = await pdf.getPage(1);

  const viewport = pdfPage.getViewport({ scale });
  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;
  cropCanvas.width = viewport.width;
  cropCanvas.height = viewport.height;

  await pdfPage.render({ canvasContext: ctx, viewport }).promise;
}

/* ---------- Mouse Crop ---------- */
pdfCanvas.addEventListener("mousedown", e => {
  drawing = true;
  startX = e.offsetX;
  startY = e.offsetY;
});

pdfCanvas.addEventListener("mousemove", e => {
  if (!drawing) return;
  endX = e.offsetX;
  endY = e.offsetY;

  cropCtx.clearRect(0,0,cropCanvas.width,cropCanvas.height);
  cropCtx.strokeStyle = "#0d6efd";
  cropCtx.lineWidth = 2;
  cropCtx.strokeRect(startX,startY,endX-startX,endY-startY);
});

pdfCanvas.addEventListener("mouseup", () => {
  drawing = false;
  const h = pdfCanvas.height;

  document.getElementById("x1").value = Math.min(startX,endX).toFixed(2);
  document.getElementById("x2").value = Math.max(startX,endX).toFixed(2);
  document.getElementById("y1").value = (h - Math.max(startY,endY)).toFixed(2);
  document.getElementById("y2").value = (h - Math.min(startY,endY)).toFixed(2);
});

/* ---------- Manual Sync ---------- */
function syncManual(el,id){
  if(el.value !== "") document.getElementById(id).value = el.value;
}
</script>
{% endblock %}
