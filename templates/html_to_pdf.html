{% extends "base.html" %}
{% load static %}

{% block title %}HTML to PDF – VetriFiles{% endblock %}

{% block content %}
<div class="col-md-8 mx-auto text-dark">
    <h4 class="mb-3 text-center text-dark">HTML → PDF</h4>

    <form id="htmlForm">
        {% csrf_token %}

        <!-- Drag & Drop -->
        <div id="drop-area"
             class="border p-3 mb-3 rounded text-center text-dark"
             style="cursor:pointer;">
            Drag & drop HTML file here or click to select
            <input type="file"
                   id="fileElem"
                   name="htmlfile"
                   accept=".html,.htm"
                   hidden>
        </div>

        <!-- HTML Textarea -->
        <textarea id="htmlInput"
                  class="form-control mb-3"
                  rows="10"
                  placeholder="<h1>Hello VetriFiles</h1>"
                  required></textarea>

        <!-- Output Filename -->
        <input type="text"
               id="filename"
               class="form-control mb-3"
               placeholder="document">

        <button type="submit" class="btn btn-success w-100">
            Convert to PDF
        </button>
    </form>

    <h5 class="mt-4">Live Preview</h5>
    <div id="preview"
         class="border p-3 rounded"
         style="min-height:300px; background:#f8f9fa;">
        Preview will appear here...
    </div>

    <p class="text-muted mt-3">
        Supports basic HTML & inline CSS.
    </p>
</div>

<script>
const dropArea  = document.getElementById("drop-area");
const fileElem  = document.getElementById("fileElem");
const htmlInput = document.getElementById("htmlInput");
const preview   = document.getElementById("preview");
const form      = document.getElementById("htmlForm");

// Drag & drop
dropArea.onclick = () => fileElem.click();
dropArea.ondragover = e => { e.preventDefault(); dropArea.classList.add("bg-light"); };
dropArea.ondragleave = () => dropArea.classList.remove("bg-light");
dropArea.ondrop = e => {
    e.preventDefault();
    dropArea.classList.remove("bg-light");
    if (e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
};

fileElem.onchange = e => {
    if (e.target.files.length) loadFile(e.target.files[0]);
};

// Load HTML file
function loadFile(file){
    if (!file.name.match(/\.html?$/i)) {
        alert("Please select an HTML file");
        return;
    }
    const reader = new FileReader();
    reader.onload = e => {
        htmlInput.value = e.target.result;
        updatePreview();
    };
    reader.readAsText(file);
}

// Live preview
function updatePreview(){
    preview.innerHTML = htmlInput.value || "Preview will appear here...";
}
htmlInput.addEventListener("input", updatePreview);

// Submit → AJAX → Download
form.onsubmit = async e => {
    e.preventDefault();

    const html = htmlInput.value.trim();
    if (!html) return alert("HTML cannot be empty");

    const fd = new FormData();
    fd.append("html", html);
    fd.append("filename",
        document.getElementById("filename").value || "document");

    const csrf =
        document.querySelector('[name=csrfmiddlewaretoken]').value;

    const res = await fetch("", {
        method: "POST",
        headers: { "X-CSRFToken": csrf },
        body: fd
    });

    if (!res.ok) {
        alert("Conversion failed");
        return;
    }

    const blob = await res.blob();
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download =
        (document.getElementById("filename").value || "document") + ".pdf";
    a.click();
};
</script>
{% endblock %}
