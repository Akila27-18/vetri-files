{% extends "base.html" %}
{% block title %}Image to PDF â€“ VetriFiles{% endblock %}

{% block content %}
<div class="row">
    <!-- IMAGE PREVIEW -->
    <div class="col-md-6">
        <h5>Image Preview</h5>
        <div id="image-preview"
             class="border p-2 d-flex flex-wrap gap-2"
             style="height:400px; overflow-y:auto; background:#f8f9fa;"></div>
    </div>

    <!-- CONTROLS -->
    <div class="col-md-6">
        <h5>Convert Images to PDF</h5>

        <form id="convert-form">
            {% csrf_token %}

            <div id="drop-area" class="border p-4 text-center mb-3">
                Drag & drop images here or click to select
                <input type="file" id="fileElem"
                       accept="image/*" multiple hidden>
            </div>

            <button class="btn btn-primary w-100">
                Convert to PDF
            </button>
        </form>
    </div>
</div>

<script>
let files=[]
const preview=document.getElementById("image-preview")
const fileElem=document.getElementById("fileElem")
const dropArea=document.getElementById("drop-area")

dropArea.onclick=()=>fileElem.click()
dropArea.ondragover=e=>{e.preventDefault();dropArea.classList.add("bg-light")}
dropArea.ondragleave=()=>dropArea.classList.remove("bg-light")
dropArea.ondrop=e=>{
    e.preventDefault()
    dropArea.classList.remove("bg-light")
    addFiles([...e.dataTransfer.files])
}
fileElem.onchange=e=>addFiles([...e.target.files])

function addFiles(newFiles){
    newFiles.forEach(f=>{
        if(!f.type.startsWith("image/")) return
        files.push(f)
        previewImage(f)
    })
}

function previewImage(file){
    const img=document.createElement("img")
    img.src=URL.createObjectURL(file)
    img.style.height="150px"
    img.className="rounded shadow-sm"
    preview.appendChild(img)
}

document.getElementById("convert-form").onsubmit=async e=>{
    e.preventDefault()
    if(!files.length) return

    const fd=new FormData()
    files.forEach(f=>fd.append("images",f))

    const csrf=document.querySelector('[name=csrfmiddlewaretoken]').value

    const res=await fetch("",{
        method:"POST",
        headers:{ "X-CSRFToken": csrf },
        body: fd
    })

    if(!res.ok){ alert("Conversion failed"); return }

    const blob=await res.blob()
    const a=document.createElement("a")
    a.href=URL.createObjectURL(blob)
    a.download=files[0].name.replace(/\.\w+$/, "_images.pdf")
    a.click()
}
</script>
{% endblock %}
